<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üì∫ Anime Collection</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    sans-serif;
                background: linear-gradient(
                    135deg,
                    #0a0a0a 0%,
                    #1a0000 50%,
                    #000000 100%
                );
                min-height: 100vh;
                padding: 20px;
                color: white;
            }

            .container {
                max-width: 100%;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
                animation: fadeInDown 0.6s ease;
            }

            .header h1 {
                font-size: 3.5em;
                margin-bottom: 10px;
                text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
                color: #e94560;
            }

            .stats {
                display: flex;
                gap: 20px;
                justify-content: center;
                flex-wrap: wrap;
                margin-bottom: 30px;
            }

            .stat-card {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                padding: 15px 30px;
                border-radius: 15px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                text-align: center;
            }

            .stat-card .number {
                font-size: 2em;
                font-weight: bold;
                color: #e94560;
            }

            .stat-card .label {
                font-size: 0.9em;
                opacity: 0.8;
                margin-top: 5px;
            }

            .input-section {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                padding: 25px;
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
                margin-bottom: 30px;
                animation: fadeInUp 0.6s ease;
                max-width: 1000px;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 30px;
                transition: all 0.3s ease;
                overflow: hidden;
            }

            .input-section.collapsed {
                max-height: 60px;
                padding: 15px 25px;
            }

            .input-section.collapsed .input-group,
            .input-section.collapsed .btn {
                display: none;
            }

            .collapse-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
            }

            .collapse-header h3 {
                margin: 0;
                font-size: 1.2em;
            }

            .collapse-icon {
                font-size: 1.5em;
                transition: transform 0.3s ease;
            }

            .input-section.collapsed .collapse-icon {
                transform: rotate(180deg);
            }

            #filtersSection {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 15px;
                padding: 20px;
                margin-bottom: 20px;
                border: 2px solid rgba(233, 69, 96, 0.3);
                transition: all 0.3s ease;
            }

            #filtersSection .collapse-header {
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid rgba(233, 69, 96, 0.3);
            }

            #filtersSection .collapse-header:hover {
                color: #e94560;
            }

            #filtersSection.collapsed {
                padding: 15px 20px;
            }

            #filtersSection.collapsed .collapse-header {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: none;
            }

            #filtersSection.collapsed .filter-grid {
                display: none;
            }

            #filtersSection.collapsed .collapse-icon {
                transform: rotate(180deg);
            }

            .input-group {
                margin-bottom: 15px;
            }

            .input-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
            }

            .input-group textarea {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid rgba(255, 255, 255, 0.2);
                background: rgba(0, 0, 0, 0.3);
                color: white;
                border-radius: 10px;
                font-size: 14px;
                font-family: "Courier New", monospace;
                min-height: 150px;
                transition: all 0.3s;
            }

            .input-group textarea:focus {
                outline: none;
                border-color: #e94560;
                box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
            }

            .btn {
                background: linear-gradient(135deg, #e94560 0%, #8b0000 100%);
                color: white;
                padding: 12px 32px;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(233, 69, 96, 0.4);
            }

            .controls {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                padding: 25px;
                border-radius: 20px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                margin-bottom: 30px;
                display: none;
                animation: fadeInUp 0.6s ease;
            }

            .controls.visible {
                display: block;
            }

            .filter-section {
                margin-bottom: 20px;
            }

            .filter-section h3 {
                margin-bottom: 10px;
                font-size: 1em;
                opacity: 0.9;
            }

            .search-box {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid rgba(255, 255, 255, 0.2);
                background: rgba(0, 0, 0, 0.3);
                color: white;
                border-radius: 10px;
                font-size: 16px;
                margin-bottom: 20px;
            }

            .search-box:focus {
                outline: none;
                border-color: #e94560;
            }

            .filter-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }

            .filter-buttons {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            #genreFilters {
                max-height: 200px;
                overflow-y: auto;
                padding-right: 5px;
            }

            #genreFilters::-webkit-scrollbar {
                width: 8px;
            }

            #genreFilters::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }

            #genreFilters::-webkit-scrollbar-thumb {
                background: #e94560;
                border-radius: 10px;
            }

            #genreFilters::-webkit-scrollbar-thumb:hover {
                background: #c41e3a;
            }

            .filter-btn {
                padding: 8px 16px;
                border: 2px solid #e94560;
                background: rgba(0, 0, 0, 0.3);
                color: white;
                border-radius: 20px;
                cursor: pointer;
                transition: all 0.3s;
                font-weight: 600;
                font-size: 0.85em;
            }

            .filter-btn:hover,
            .filter-btn.active {
                background: #e94560;
                transform: scale(1.05);
            }

            .sort-controls {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }

            .sort-controls select {
                padding: 10px 16px;
                border: 2px solid rgba(255, 255, 255, 0.2);
                background: rgba(0, 0, 0, 0.3);
                color: white;
                border-radius: 10px;
                font-size: 14px;
                cursor: pointer;
            }

            .cards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 20px;
                margin-top: 30px;
            }

            .card {
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 0;
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transition:
                    transform 0.3s,
                    box-shadow 0.3s,
                    border-color 0.3s;
                animation: fadeInUp 0.6s ease;
                position: relative;
                overflow: hidden;
                cursor: pointer;
            }

            .card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 4px;
                background: linear-gradient(90deg, #e94560 0%, #8b0000 100%);
            }

            .card:hover {
                transform: translateY(-10px) scale(1.02);
                box-shadow: 0 20px 40px rgba(233, 69, 96, 0.4);
                border-color: #e94560;
            }

            .card-poster {
                width: 100%;
                height: 280px;
                object-fit: cover;
                background: linear-gradient(
                    135deg,
                    rgba(233, 69, 96, 0.2),
                    rgba(0, 0, 0, 0.4)
                );
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2em;
            }

            .card-poster.loading {
                animation: pulse 1.5s ease-in-out infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 0.6;
                }
                50% {
                    opacity: 1;
                }
            }

            .card-content {
                padding: 15px;
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: start;
                margin-bottom: 12px;
            }

            .card h3 {
                color: #fff;
                font-size: 1.1em;
                flex: 1;
            }

            .rating-badge {
                background: linear-gradient(135deg, #e94560, #8b0000);
                color: white;
                padding: 6px 10px;
                border-radius: 8px;
                font-weight: bold;
                font-size: 0.95em;
                min-width: 45px;
                text-align: center;
                box-shadow: 0 4px 10px rgba(233, 69, 96, 0.3);
            }

            .rating-badge.gold {
                background: linear-gradient(135deg, #ffd700, #ffb700);
                color: #000;
                box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5);
            }

            .card-badges {
                display: flex;
                gap: 6px;
                flex-wrap: wrap;
                margin-bottom: 12px;
            }

            .badge {
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 0.7em;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .badge.anime {
                background: rgba(52, 152, 219, 0.3);
                border: 1px solid #3498db;
                color: #3498db;
            }

            .badge.ova {
                background: rgba(155, 89, 182, 0.3);
                border: 1px solid #9b59b6;
                color: #9b59b6;
            }

            .badge.rewatch {
                background: rgba(46, 204, 113, 0.3);
                border: 1px solid #2ecc71;
                color: #2ecc71;
            }

            .badge.not-watched {
                background: rgba(231, 76, 60, 0.3);
                border: 1px solid #e74c3c;
                color: #e74c3c;
            }

            .badge.bogdan {
                background: rgba(191, 64, 255, 0.3);
                border: 2px solid #bf40ff;
                color: #bf40ff;
                font-weight: 700;
            }

            .badge.physical {
                background: rgba(230, 126, 34, 0.3);
                border: 1px solid #e67e22;
                color: #e67e22;
            }

            .badge.physical-1 {
                background: rgba(230, 126, 34, 0.3);
                border: 1px solid #e67e22;
                color: #e67e22;
            }

            .badge.physical-2 {
                background: rgba(155, 89, 182, 0.3);
                border: 1px solid #9b59b6;
                color: #9b59b6;
            }

            .badge.physical-3 {
                background: rgba(52, 152, 219, 0.3);
                border: 1px solid #3498db;
                color: #3498db;
            }

            .badge.physical-4 {
                background: rgba(46, 204, 113, 0.3);
                border: 1px solid #2ecc71;
                color: #2ecc71;
            }

            .badge.physical-5 {
                background: rgba(241, 196, 15, 0.3);
                border: 1px solid #f1c40f;
                color: #f1c40f;
            }

            .card-field {
                margin: 6px 0;
                padding: 5px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                font-size: 0.85em;
            }

            .card-field:last-child {
                border-bottom: none;
            }

            .field-label {
                font-weight: 600;
                color: #e94560;
                font-size: 0.8em;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                opacity: 0.9;
            }

            .field-value {
                color: #fff;
                margin-top: 4px;
                opacity: 0.9;
            }

            .field-value.golden {
                background: linear-gradient(135deg, #ffd700, #ffb700);
                color: #000;
                font-weight: bold;
                padding: 6px 12px;
                border-radius: 8px;
                display: inline-block;
                box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5);
            }

            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                animation: fadeIn 0.3s ease;
            }

            .modal.visible {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .modal-content {
                background: linear-gradient(135deg, #0a0a0a 0%, #1a0000 100%);
                border-radius: 20px;
                max-width: 1100px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                position: relative;
                border: 2px solid rgba(233, 69, 96, 0.5);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                animation: slideUp 0.3s ease;
                display: flex;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes slideUp {
                from {
                    transform: translateY(50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-poster {
                width: 350px;
                min-width: 350px;
                height: auto;
                min-height: 100%;
                object-fit: contain;
                border-radius: 20px 0 0 20px;
                background: linear-gradient(
                    135deg,
                    rgba(233, 69, 96, 0.3),
                    rgba(0, 0, 0, 0.5)
                );
            }

            .modal-poster.hidden {
                display: none;
            }

            .modal-body {
                padding: 30px;
                flex: 1;
                overflow-y: auto;
            }

            .modal-header {
                margin-bottom: 20px;
            }

            .modal-header h2 {
                font-size: 2.5em;
                color: #fff;
                margin-bottom: 15px;
                padding-right: 60px;
            }

            .modal-rating {
                display: inline-block;
            }

            .close-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.7);
                border: 2px solid #e94560;
                color: white;
                font-size: 2em;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
                z-index: 10;
            }

            .close-btn:hover {
                background: #e94560;
                transform: rotate(90deg);
            }

            .modal-badges {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-bottom: 20px;
            }

            .modal-field {
                margin: 15px 0;
                padding: 15px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 10px;
                border-left: 4px solid #e94560;
            }

            .modal-field-label {
                font-weight: 600;
                color: #e94560;
                font-size: 0.9em;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 8px;
            }

            .modal-field-value {
                color: #fff;
                font-size: 1.1em;
                line-height: 1.6;
            }

            .modal-field-value.golden {
                background: linear-gradient(135deg, #ffd700, #ffb700);
                color: #000;
                font-weight: bold;
                padding: 8px 16px;
                border-radius: 8px;
                display: inline-block;
                box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5);
            }

            .loading,
            .success,
            .error {
                text-align: center;
                padding: 20px;
                border-radius: 10px;
                margin: 20px auto;
                max-width: 1000px;
                display: none;
            }

            .loading.visible,
            .success.visible,
            .error.visible {
                display: block;
            }

            .loading {
                color: white;
                font-size: 1.5em;
            }

            .success {
                background: rgba(46, 204, 113, 0.2);
                border: 2px solid #2ecc71;
                color: #2ecc71;
            }

            .error {
                background: rgba(231, 76, 60, 0.2);
                border: 2px solid #e74c3c;
                color: #e74c3c;
            }

            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @media (max-width: 768px) {
                .header h1 {
                    font-size: 2em;
                }

                .cards-grid {
                    grid-template-columns: 1fr;
                }

                .filter-grid {
                    grid-template-columns: 1fr;
                }

                .modal.visible {
                    padding: 10px;
                }

                .modal-content {
                    max-height: 95vh;
                    flex-direction: column;
                    border-radius: 15px;
                }

                .modal-poster {
                    width: 120px;
                    min-width: 120px;
                    height: auto;
                    max-height: 180px;
                    object-fit: contain;
                    border-radius: 10px;
                    margin: 15px;
                    float: left;
                }

                .modal-poster.hidden {
                    display: none;
                }

                .modal-body {
                    padding: 15px;
                    overflow: auto;
                }

                .modal-badges {
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                    margin-bottom: 10px;
                    margin-top: 15px;
                }

                .modal-header {
                    clear: both;
                    padding-top: 0;
                }

                .modal-header h2 {
                    font-size: 1.3em;
                    padding-right: 50px;
                    margin-bottom: 8px;
                }

                .modal-rating {
                    margin-bottom: 10px;
                }

                .close-btn {
                    top: 15px;
                    right: 15px;
                    width: 40px;
                    height: 40px;
                    font-size: 1.5em;
                }

                .modal-field {
                    margin: 10px 0;
                    padding: 12px;
                }

                .modal-field-value {
                    font-size: 1em;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üì∫ Anime Collection</h1>
            </div>

            <div class="stats" id="stats"></div>

            <div class="input-section" id="inputSection">
                <div class="collapse-header" onclick="toggleInputSection()">
                    <h3>üìã Load Your Collection</h3>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div class="input-group">
                    <label for="csvData"
                        >Paste Your Watchlist (Ctrl+A, Ctrl+C, Ctrl+V)</label
                    >
                    <textarea
                        id="csvData"
                        placeholder="Paste your data here..."
                    ></textarea>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap">
                    <button class="btn" onclick="loadData()">
                        Load from Paste
                    </button>
                    <button class="btn" onclick="loadFromGitHub()">
                        üîÑ Reload from GitHub
                    </button>
                </div>
            </div>

            <div class="error" id="error"></div>
            <div class="success" id="success"></div>
            <div class="loading" id="loading">
                Loading your collection... ‚ú®
            </div>

            <div class="controls" id="controls">
                <input
                    type="text"
                    class="search-box"
                    id="searchBox"
                    placeholder="üîç Search by title, genre, or anything..."
                    onkeyup="filterCards()"
                />

                <div id="filtersSection" class="collapsed">
                    <div class="collapse-header" onclick="toggleFilters()">
                        <h3>üîç Filters</h3>
                        <span class="collapse-icon">‚ñº</span>
                    </div>

                    <div class="filter-grid">
                        <div class="filter-section">
                            <h3>üì∫ Type</h3>
                            <div class="filter-buttons" id="typeFilters"></div>
                        </div>

                        <div class="filter-section">
                            <h3>üé≠ Genre</h3>
                            <div class="filter-buttons" id="genreFilters"></div>
                        </div>

                        <div class="filter-section">
                            <h3>‚≠ê Rating</h3>
                            <div class="filter-buttons" id="ratingFilters"></div>
                        </div>

                        <div class="filter-section">
                            <h3>üëÄ Watch Status</h3>
                            <div class="filter-buttons" id="physicalFormatFilters"></div>
                        </div>
                    </div>
                </div>

                <div class="sort-controls">
                    <label style="font-weight: 600">Sort by:</label>
                    <select id="sortSelect" onchange="sortCards()">
                        <option value="name">Name (A-Z)</option>
                        <option value="rating-desc">
                            Rating (High to Low)
                        </option>
                        <option value="rating-asc">Rating (Low to High)</option>
                    </select>
                </div>
            </div>

            <div class="cards-grid" id="cardsGrid"></div>
        </div>

        <div class="modal" id="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">√ó</button>
                <img id="modalPoster" class="modal-poster hidden" alt="" />
                <div class="modal-body" id="modalBody"></div>
            </div>
        </div>

        <script>
            // GitHub CSV file URL - UPDATE THIS WITH YOUR REPO URL
            const CSV_FILE_URL =
                "https://raw.githubusercontent.com/NiceLifeCity/animes/main/anime.csv";

            let allData = [];
            let filteredData = [];
            let headers = [];
            let activeFilters = {
                type: "all",
                genre: "all",
                rating: "all",
                watched: "all",
            };

            function showError(message) {
                const errorEl = document.getElementById("error");
                errorEl.textContent = message;
                errorEl.classList.add("visible");
                setTimeout(() => errorEl.classList.remove("visible"), 8000);
            }

            function showSuccess(message) {
                const successEl = document.getElementById("success");
                successEl.textContent = message;
                successEl.classList.add("visible");
                setTimeout(() => successEl.classList.remove("visible"), 3000);

                // Collapse input section after successful load
                const inputSection = document.getElementById("inputSection");
                setTimeout(() => {
                    inputSection.classList.add("collapsed");
                }, 1000);
            }

            function toggleInputSection() {
                document
                    .getElementById("inputSection")
                    .classList.toggle("collapsed");
            }

            function toggleFilters() {
                document
                    .getElementById("filtersSection")
                    .classList.toggle("collapsed");
            }

            async function loadFromGitHub() {
                showLoading(true);

                try {
                    // Add cache-busting parameter to always fetch latest version
                    const cacheBuster = `?t=${new Date().getTime()}`;
                    const response = await fetch(CSV_FILE_URL + cacheBuster);
                    if (!response.ok) {
                        throw new Error("Failed to load CSV from GitHub");
                    }

                    const csvText = await response.text();
                    parseCSV(csvText);
                    showSuccess(
                        "‚úÖ Collection loaded from GitHub! Found " +
                            allData.length +
                            " titles.",
                    );
                } catch (error) {
                    showError("Error loading from GitHub: " + error.message);
                    showLoading(false);
                }
            }

            // Auto-load on page load if CSV_FILE_URL is configured
            window.addEventListener("DOMContentLoaded", function () {
                if (CSV_FILE_URL && !CSV_FILE_URL.includes("YOUR_USERNAME")) {
                    loadFromGitHub();
                }
            });

            function showLoading(show) {
                document
                    .getElementById("loading")
                    .classList.toggle("visible", show);
            }

            function loadData() {
                const csvText = document.getElementById("csvData").value.trim();

                if (!csvText) {
                    showError("Please paste data in the text box");
                    return;
                }

                showLoading(true);

                try {
                    parseCSV(csvText);
                    showSuccess(
                        "‚úÖ Collection loaded! Found " +
                            allData.length +
                            " titles.",
                    );
                } catch (error) {
                    showError("Error parsing data: " + error.message);
                    showLoading(false);
                }
            }

            function parseCSV(csvText) {
                const lines = csvText
                    .split("\n")
                    .filter((line) => line.trim() !== "");

                if (lines.length < 2) {
                    showError("Not enough data");
                    showLoading(false);
                    return;
                }

                const firstLine = lines[0];
                const delimiter = firstLine.includes("\t") ? "\t" : ",";

                const rawHeaders = parseCSVLine(lines[0], delimiter);

                // Create column mapping for anime.csv structure
                const columnMap = {
                    "Anime Title": "Name",
                    "Rating": "Rating",
                    "Genres": "Genre",
                    "Type": "Type",
                    "Season": "Season",
                    "Episodes": "Episodes",
                    "Episodes Total": "Episodes Total",
                    "Start Date": "Start Date",
                    "End Date": "End Date",
                    "Watched": "Watched"
                };

                allData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i], delimiter);
                    if (values.some((v) => v.trim() !== "")) {
                        const row = {};
                        rawHeaders.forEach((header, index) => {
                            const mappedHeader = columnMap[header] || header;
                            row[mappedHeader] = values[index] || "";
                        });
                        if (row["Name"] && row["Name"].trim()) {
                            allData.push(row);
                        }
                    }
                }

                // Set display headers (only the ones we want to show in cards)
                headers = ["Season", "Episodes", "Episodes Total", "Start Date", "End Date", "Genre"];

                if (allData.length === 0) {
                    showError("No data rows found");
                    showLoading(false);
                    return;
                }

                filteredData = [...allData];
                displayStats();
                createFilters();
                displayCards(filteredData);
                document.getElementById("controls").classList.add("visible");
                showLoading(false);
            }

            function parseCSVLine(line, delimiter = ",") {
                const values = [];
                let current = "";
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === delimiter && !inQuotes) {
                        values.push(current.trim());
                        current = "";
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                return values;
            }


            function displayStats() {
                const statsEl = document.getElementById("stats");
                const totalCount = allData.length;
                const anime = allData.filter(
                    (r) => r["Type"] === "Anime",
                ).length;
                const ova = allData.filter(
                    (r) => r["Type"] === "OVA",
                ).length;
                const watchedAnime = allData.filter(
                    (r) => r["Type"] === "Anime" && r["Watched"] === "Yes",
                ).length;
                const watchedOVA = allData.filter(
                    (r) => r["Type"] === "OVA" && r["Watched"] === "Yes",
                ).length;

                statsEl.innerHTML = `
                <div class="stat-card">
                    <div class="number">${totalCount}</div>
                    <div class="label">Total Titles</div>
                </div>
                <div class="stat-card">
                    <div class="number">${anime}</div>
                    <div class="label">Anime</div>
                </div>
                <div class="stat-card">
                    <div class="number">${ova}</div>
                    <div class="label">OVA</div>
                </div>
                <div class="stat-card">
                    <div class="number">${watchedAnime}</div>
                    <div class="label">Watched Anime</div>
                </div>
                <div class="stat-card">
                    <div class="number">${watchedOVA}</div>
                    <div class="label">Watched OVA</div>
                </div>
            `;
            }

            function createFilters() {
                // Type filters
                const typeContainer = document.getElementById("typeFilters");
                typeContainer.innerHTML = "";
                ["All", "Anime", "OVA"].forEach((type) => {
                    const btn = document.createElement("button");
                    btn.className =
                        "filter-btn" + (type === "All" ? " active" : "");
                    btn.textContent = type;
                    btn.onclick = () => setFilter("type", type.toLowerCase());
                    typeContainer.appendChild(btn);
                });

                // Genre filters
                const genreContainer = document.getElementById("genreFilters");
                genreContainer.innerHTML = "";
                const genres = new Map(); // Use Map to track normalized -> display name
                allData.forEach((row) => {
                    if (row["Genre"]) {
                        row["Genre"]
                            .split(",")
                            .forEach((g) => {
                                const trimmed = g.trim();
                                const normalized = trimmed.toLowerCase();
                                // Keep the first occurrence's capitalization
                                if (!genres.has(normalized)) {
                                    genres.set(normalized, trimmed);
                                }
                            });
                    }
                });
                const allGenreBtn = document.createElement("button");
                allGenreBtn.className = "filter-btn active";
                allGenreBtn.textContent = "All";
                allGenreBtn.onclick = () => setFilter("genre", "all");
                genreContainer.appendChild(allGenreBtn);

                [...genres.entries()]
                    .sort((a, b) => a[1].localeCompare(b[1]))
                    .forEach(([normalized, displayName]) => {
                        const btn = document.createElement("button");
                        btn.className = "filter-btn";
                        btn.textContent = displayName;
                        btn.onclick = () => setFilter("genre", normalized);
                        genreContainer.appendChild(btn);
                    });

                // Rating filters
                const ratingContainer =
                    document.getElementById("ratingFilters");
                ratingContainer.innerHTML = "";
                ["All", "11", "10", "9", "8", "7", "6", "5", "4", "3", "2", "1"].forEach((rating) => {
                    const btn = document.createElement("button");
                    btn.className =
                        "filter-btn" + (rating === "All" ? " active" : "");
                    btn.textContent = rating === "All" ? "All" : rating;
                    btn.onclick = () =>
                        setFilter("rating", rating.toLowerCase());
                    ratingContainer.appendChild(btn);
                });

                // Watched Status filters
                const formatContainer = document.getElementById("physicalFormatFilters");
                formatContainer.innerHTML = "";
                ["All", "Watched", "Not Watched"].forEach((status) => {
                    const btn = document.createElement("button");
                    btn.className =
                        "filter-btn" + (status === "All" ? " active" : "");
                    btn.textContent = status;
                    btn.onclick = () => setFilter("watched", status.toLowerCase().replace(" ", "-"));
                    formatContainer.appendChild(btn);
                });
            }

            function setFilter(category, value) {
                activeFilters[category] = value;

                document
                    .querySelectorAll(`#${category}Filters .filter-btn`)
                    .forEach((btn) => {
                        btn.classList.remove("active");
                    });
                event.target.classList.add("active");

                applyFilters();
            }

            function applyFilters() {
                filteredData = allData.filter((row) => {
                    if (
                        activeFilters.type !== "all" &&
                        row["Type"].toLowerCase() !== activeFilters.type
                    ) {
                        return false;
                    }

                    if (activeFilters.genre !== "all") {
                        const rowGenres = row["Genre"].toLowerCase();
                        if (!rowGenres.includes(activeFilters.genre)) {
                            return false;
                        }
                    }

                    if (activeFilters.rating !== "all") {
                        const rating = parseFloat(row["Rating"]) || 0;
                        const filterRating = parseFloat(activeFilters.rating);
                        if (rating !== filterRating) {
                            return false;
                        }
                    }

                    if (activeFilters.watched !== "all") {
                        if (
                            activeFilters.watched === "watched" &&
                            row["Watched"] !== "Yes"
                        )
                            return false;
                        if (
                            activeFilters.watched === "not-watched" &&
                            row["Watched"] !== "No"
                        )
                            return false;
                    }

                    return true;
                });

                filterCards();
            }

            function filterCards() {
                const searchTerm = document
                    .getElementById("searchBox")
                    .value.toLowerCase();

                const filtered = filteredData.filter((row) => {
                    return Object.values(row).some((value) =>
                        String(value).toLowerCase().includes(searchTerm),
                    );
                });

                displayCards(filtered);
            }

            function sortCards() {
                const sortBy = document.getElementById("sortSelect").value;

                filteredData.sort((a, b) => {
                    switch (sortBy) {
                        case "name":
                            return a["Name"].localeCompare(b["Name"]);
                        case "rating-desc":
                            return (
                                (parseFloat(b["Rating"]) || 0) -
                                (parseFloat(a["Rating"]) || 0)
                            );
                        case "rating-asc":
                            return (
                                (parseFloat(a["Rating"]) || 0) -
                                (parseFloat(b["Rating"]) || 0)
                            );
                        case "season":
                            return (
                                (parseInt(b["Season"]) || 0) -
                                (parseInt(a["Season"]) || 0)
                            );
                        case "date-latest":
                            return (b["End Date"] || "").localeCompare(
                                a["End Date"] || "",
                            );
                        case "date-first":
                            return (b["Start Date"] || "").localeCompare(
                                a["Start Date"] || "",
                            );
                        default:
                            return 0;
                    }
                });

                filterCards();
            }

            function displayCards(data) {
                const grid = document.getElementById("cardsGrid");
                grid.innerHTML = "";

                if (data.length === 0) {
                    grid.innerHTML =
                        '<p style="color: white; text-align: center; width: 100%; font-size: 1.2em;">No titles match your filters üì∫</p>';
                    return;
                }

                for (const [index, row] of data.entries()) {
                    const card = document.createElement("div");
                    card.className = "card";
                    card.style.animationDelay = `${index * 0.03}s`;
                    card.onclick = () => openModal(row);

                    const posterDiv = document.createElement("div");
                    posterDiv.className = "card-poster";
                    posterDiv.textContent = "üì∫";

                    const rating = row["Rating"];
                    const isWatched = row["Watched"] === "Yes";

                    const ratingValue = parseFloat(rating);
                    const isGoldRating = ratingValue === 11;

                    let html = `
                    <div class="card-content">
                        <div class="card-header">
                            <h3>${row["Name"]}</h3>
                            ${rating && rating !== "?" ? `<div class="rating-badge ${isGoldRating ? 'gold' : ''}">${rating}/11</div>` : ""}
                        </div>
                        <div class="card-badges">
                            <span class="badge ${row["Type"].toLowerCase()}">${row["Type"]}</span>
                            ${isWatched ? '<span class="badge rewatch">‚úÖ Watched</span>' : '<span class="badge not-watched">‚è≥ Not Watched</span>'}
                        </div>
                `;

                    headers.forEach((header) => {
                        if (
                            row[header] &&
                            row[header].trim() &&
                            header !== "Name" &&
                            header !== "Type" &&
                            header !== "Rating" &&
                            header !== "Watched"
                        ) {
                            html += `<div class="card-field"><div class="field-label">${header}</div><div class="field-value">${row[header]}</div></div>`;
                        }
                    });

                    html += "</div>";

                    card.innerHTML = html;
                    card.insertBefore(posterDiv, card.firstChild);
                    grid.appendChild(card);
                }
            }

            function openModal(row) {
                const modal = document.getElementById("modal");
                const modalBody = document.getElementById("modalBody");
                const modalPoster = document.getElementById("modalPoster");

                const rating = row["Rating"];
                const isWatched = row["Watched"] === "Yes";

                const ratingValue = parseFloat(rating);
                const isGoldRating = ratingValue === 11;

                let html = `
                <div class="modal-badges">
                    <span class="badge ${row["Type"].toLowerCase()}" style="font-size: 1em; padding: 8px 16px;">${row["Type"]}</span>
                    ${isWatched ? '<span class="badge rewatch" style="font-size: 1em; padding: 8px 16px;">‚úÖ Watched</span>' : '<span class="badge not-watched" style="font-size: 1em; padding: 8px 16px;">‚è≥ Not Watched</span>'}
                </div>
                <div class="modal-header">
                    <h2>${row["Name"]}</h2>
                    ${rating && rating !== "?" ? `<div class="modal-rating"><div class="rating-badge ${isGoldRating ? 'gold' : ''}" style="font-size: 1.5em; padding: 12px 20px;">${rating}/11</div></div>` : ""}
                </div>
            `;

                headers.forEach((header) => {
                    if (
                        row[header] &&
                        row[header].trim() &&
                        header !== "Name" &&
                        header !== "Type" &&
                        header !== "Rating" &&
                        header !== "Watched"
                    ) {
                        html += `
                        <div class="modal-field">
                            <div class="modal-field-label">${header}</div>
                            <div class="modal-field-value">${row[header]}</div>
                        </div>
                    `;
                    }
                });

                modalBody.innerHTML = html;

                // Hide poster since we're not fetching from API
                modalPoster.classList.add("hidden");

                modal.classList.add("visible");
                document.body.style.overflow = "hidden";
            }

            function closeModal() {
                const modal = document.getElementById("modal");
                modal.classList.remove("visible");
                document.body.style.overflow = "auto";
            }

            // Close modal on outside click
            document.getElementById("modal").onclick = function (event) {
                if (event.target === this) {
                    closeModal();
                }
            };

            // Close modal on Escape key
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape") {
                    closeModal();
                }
            });
        </script>
    </body>
</html>
